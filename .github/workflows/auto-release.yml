name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - 'magisk-rclone/module.prop'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch at least 2 commits to compare

      - name: Check if version changed
        id: check_version
        run: |
          # Extract current version
          CURRENT_VERSION=$(grep -oP '^version=\K.*' magisk-rclone/module.prop)
          echo "Current version: $CURRENT_VERSION"
          
          # Try to get previous version (if commit history exists)
          git show HEAD~1:magisk-rclone/module.prop > /tmp/old_module.prop 2>/dev/null || echo "version=" > /tmp/old_module.prop
          PREVIOUS_VERSION=$(grep -oP '^version=\K.*' /tmp/old_module.prop || echo "")
          echo "Previous version: $PREVIOUS_VERSION"
          
          # Check if version actually changed
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] && [ -n "$CURRENT_VERSION" ]; then
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "version_changed=true" >> $GITHUB_OUTPUT
          else
            echo "Version did not change"
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Get rclone release information
        if: steps.check_version.outputs.version_changed == 'true'
        id: rclone_info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          echo "Fetching rclone release information for $VERSION"
          
          # Fetch release info from rclone GitHub
          RELEASE_INFO=$(curl -s --fail \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "User-Agent: rclone-fuse3-magisk-auto-release" \
            "https://api.github.com/repos/rclone/rclone/releases/tags/$VERSION")
          
          if [ -z "$RELEASE_INFO" ] || echo "$RELEASE_INFO" | grep -q "Not Found"; then
            echo "Warning: Could not fetch rclone release info for $VERSION"
            RELEASE_URL="https://github.com/rclone/rclone/releases/tag/$VERSION"
            RELEASE_DATE=$(date +%Y-%m-%d)
          else
            RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.html_url')
            RELEASE_DATE=$(echo "$RELEASE_INFO" | jq -r '.published_at' | cut -d'T' -f1)
          fi
          
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          
          # Generate changelog URL
          # Format: v1.72.0 -> v1-72-0-2025-11-21
          VERSION_HASH=$(echo "$VERSION" | sed 's/v/v/' | sed 's/\./-/g')
          CHANGELOG_URL="https://rclone.org/changelog/#${VERSION_HASH}-${RELEASE_DATE}"
          echo "changelog_url=$CHANGELOG_URL" >> $GITHUB_OUTPUT
          
          echo "Release URL: $RELEASE_URL"
          echo "Release Date: $RELEASE_DATE"
          echo "Changelog URL: $CHANGELOG_URL"

      - name: Check if release already exists
        if: steps.check_version.outputs.version_changed == 'true'
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          
          # Check if the release already exists
          if gh release view "$VERSION" > /dev/null 2>&1; then
            echo "Release $VERSION already exists"
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $VERSION does not exist"
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: steps.check_version.outputs.version_changed == 'true' && steps.check_release.outputs.release_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          RELEASE_URL="${{ steps.rclone_info.outputs.release_url }}"
          CHANGELOG_URL="${{ steps.rclone_info.outputs.changelog_url }}"
          RELEASE_DATE="${{ steps.rclone_info.outputs.release_date }}"
          
          # Create release body
          cat > /tmp/release_body.md << EOF
          ## Rclone $VERSION Release
          
          This release updates the rclone version to **$VERSION** (Released: $RELEASE_DATE).
          
          ### ðŸ“¦ Download
          The build artifacts will be available shortly after the build workflow completes.
          
          ### ðŸ”— Links
          - **Rclone GitHub Release**: $RELEASE_URL
          - **Official Changelog**: $CHANGELOG_URL
          
          ### ðŸ“ Release Notes
          Please refer to the official rclone changelog for detailed release notes and changes.
          
          ---
          
          *This release was automatically created when the version in module.prop was updated.*  
          *æ­¤ç‰ˆæœ¬æ˜¯åœ¨ module.prop ä¸­çš„ç‰ˆæœ¬æ›´æ–°æ—¶è‡ªåŠ¨åˆ›å»ºçš„ã€‚*
          EOF
          
          # Create the release
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes-file /tmp/release_body.md \
            --draft=false \
            --prerelease=false

      - name: Summary
        if: steps.check_version.outputs.version_changed == 'true'
        run: |
          if [ "${{ steps.check_release.outputs.release_exists }}" = "true" ]; then
            echo "â„¹ï¸ Release ${{ steps.check_version.outputs.version }} already exists, skipping creation"
          else
            echo "âœ… Successfully created release for version ${{ steps.check_version.outputs.version }}"
            echo "   Release URL: ${{ steps.rclone_info.outputs.release_url }}"
            echo "   Changelog URL: ${{ steps.rclone_info.outputs.changelog_url }}"
          fi

      - name: No Version Change
        if: steps.check_version.outputs.version_changed == 'false'
        run: |
          echo "â„¹ï¸ Version did not change in this commit"
          echo "   No release will be created"
